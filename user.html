<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>User Dashboard - Helpdesk IT RSUD Dr. Soetomo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="assets/plugins/global/plugins.bundle.css" rel="stylesheet" type="text/css" />
  <link href="assets/css/style.bundle.css" rel="stylesheet" type="text/css" />

  <style>
    body {
      background-color: #f5f8fa;
    }
    .navbar {
      background-color: #ffffff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 15px 30px;
    }
    .navbar h3 {
      margin: 0;
      font-weight: 700;
      color: #2b2b2b;
    }
    .card {
      border-radius: 12px;
    }
    .table img {
      border-radius: 6px;
    }
  </style>
</head>

<body class="bg-body">

  <nav class="navbar d-flex justify-content-between align-items-center">
    <h3>Helpdesk IT RSUD Dr. Soetomo</h3>
    <div class="d-flex align-items-center">
      <span class="fw-semibold me-4 text-gray-700">ðŸ‘¤ <span id="userName"></span></span>
      <button class="btn btn-sm btn-light-danger fw-bold" id="logoutBtn">Logout</button>
    </div>
  </nav>

  <div class="container py-10">
    <div class="card shadow-sm mb-10">
      <div class="card-header">
        <h4 class="card-title fw-bold text-primary">Form Laporan Insiden</h4>
      </div>
      <div class="card-body">
        <form id="reportForm">
          <div class="row g-5">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Judul Masalah</label>
              <input id="judul" type="text" class="form-control form-control-solid" placeholder="Contoh: Komputer Tidak Menyala" required>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Kategori</label>
              <select id="kategori" class="form-select form-select-solid" required>
                <option value="">-- Pilih Kategori --</option>
                <option value="Jaringan">Jaringan</option>
                <option value="EMR">EMR / SIMRS</option>
                <option value="Hardware">Hardware</option>
                <option value="Software">Software</option>
                <option value="AksesAkun">Akses Akun</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Unit Kerja / Instalasi</label>
              <input id="unit" type="text" class="form-control form-control-solid" placeholder="Contoh: Instalasi Radiologi" required>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Tingkat Urgensi</label>
              <select id="urgensi" class="form-select form-select-solid" required>
                <option value="">-- Pilih Urgensi --</option>
                <option value="Rendah">Rendah</option>
                <option value="Sedang">Sedang</option>
                <option value="Tinggi">Tinggi</option>
              </select>
            </div>
          </div>

          <div class="mt-5">
            <label class="form-label fw-semibold">Deskripsi</label>
            <textarea id="deskripsi" class="form-control form-control-solid" rows="4" placeholder="Jelaskan masalah secara detail" required></textarea>
          </div>

          <div class="mt-5">
            <label class="form-label fw-semibold">Upload Lampiran (Screenshot/Log)</label>
            <input id="foto" type="file" class="form-control form-control-solid" accept="image/*" required>
          </div>

          <div class="text-end mt-6">
            <button type="submit" class="btn btn-primary fw-bold px-8">Kirim Laporan</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header">
        <h4 class="card-title fw-bold text-primary">Riwayat Laporan Saya</h4>
      </div>
      <div class="card-body">
        <table class="table align-middle table-striped table-row-dashed fs-6 gy-5">
          <thead class="text-gray-600 fw-bold">
            <tr>
              <th>No Tiket</th>
              <th>Judul</th>
              <th>Kategori</th>
              <th>Urgensi</th>
              <th>Status</th>
              <th>Tanggal</th>
            </tr>
          </thead>
          <tbody id="myReports"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="assets/plugins/global/plugins.bundle.js"></script>
  <script src="assets/js/scripts.bundle.js"></script>

  <script>
    const username = localStorage.getItem("username");
    const role = localStorage.getItem("role");
    if (!username || role !== "user") {
      window.location.href = "login.html";
    }

    document.getElementById("userName").textContent = username;

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("username");
      localStorage.removeItem("role");
      window.location.href = "login.html";
    });

    let reports = JSON.parse(localStorage.getItem("reports")) || [];

    function generateTicketNo(kategori, urgensi) {
      const prefix = {
        "Jaringan": "NET",
        "EMR": "EMR",
        "Hardware": "HW",
        "Software": "SW",
        "AksesAkun": "ACC"
      }[kategori] || "GEN";

      const today = new Date();
      const date = today.toISOString().slice(0,10).replace(/-/g,"");
      const count = reports.filter(r => r.tanggal?.startsWith(today.toISOString().slice(0,10))).length + 1;
      const number = String(count).padStart(3,"0");

      return `${prefix}-${urgensi}-${date}-${number}`;
    }

    function renderReports(){
      const tbody = document.getElementById("myReports");
      tbody.innerHTML = "";
      const myReports = reports.filter(r => r.user === username);
      if (myReports.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Belum ada laporan.</td></tr>`;
        return;
      }
      myReports.forEach(r => {
        const badgeClass = r.urgensi === "Tinggi" ? "badge-light-danger" : r.urgensi === "Sedang" ? "badge-light-warning" : "badge-light-success";
        const statusClass = r.status === "Selesai" ? "badge-success" : "badge-secondary";
        tbody.innerHTML += `
          <tr>
            <td class="fw-bold text-gray-800">${r.noTiket}</td>
            <td>${r.judul}</td>
            <td>${r.kategori}</td>
            <td><span class="badge ${badgeClass}">${r.urgensi}</span></td>
            <td><span class="badge ${statusClass}">${r.status}</span></td>
            <td>${r.tanggal}</td>
          </tr>
        `;
      });
    }

    document.getElementById("reportForm").addEventListener("submit", function(e){
      e.preventDefault();
      const judul = document.getElementById("judul").value;
      const deskripsi = document.getElementById("deskripsi").value;
      const urgensi = document.getElementById("urgensi").value;
      const kategori = document.getElementById("kategori").value;
      const unit = document.getElementById("unit").value;
      const foto = document.getElementById("foto").files[0];

      if (!foto) {
        alert("Harap upload foto!");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(ev){
        const noTiket = generateTicketNo(kategori, urgensi);
        const tanggal = new Date().toISOString().slice(0,10);

        reports.push({
          noTiket,
          user: username,
          judul,
          kategori,
          unit,
          deskripsi,
          urgensi,
          foto: ev.target.result,
          status: "Menunggu",
          tanggal
        });

        localStorage.setItem("reports", JSON.stringify(reports));
        renderReports();
        document.getElementById("reportForm").reset();

        alert(`Laporan berhasil dikirim!\nNomor Tiket Anda: ${noTiket}`);
      };
      reader.readAsDataURL(foto);
    });

    renderReports();
  </script>
</body>
</html>
